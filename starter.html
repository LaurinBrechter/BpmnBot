<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>BPMNBot</title>

  <!-- required modeler styles -->
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.8.0/dist/assets/bpmn-js.css">
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.8.0/dist/assets/diagram-js.css">
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.8.0/dist/assets/bpmn-font/css/bpmn.css">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- modeler distro -->
  <script src="https://unpkg.com/bpmn-js@17.8.0/dist/bpmn-modeler.development.js"></script>

  <!-- needed for this example only -->
  <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>

  <!-- example styles -->
  <style>
    @import "style.css";
  </style>
</head>

<body>
  <div id="main-container" class="h-[85%] flex flex-row ">
    <div id="canvas" class="h-[100%] w-[80%]"></div>
    <div id="side-panel" class="w-[20%] bg-slate-300">
      Versions
    </div>
  </div>
  <div id="chat-container" class="h-[15%] p-4">
    <input type="text" id="chat-input" class="w-[80%] h-[20%] border-2 border-gray-300">
    <button id="chat-send" class="w-[20%] h-[30%] bg-blue-400" onclick="OpenAICompletion()">Send</button>
    <input type="password" id="openai-api-token">
  </div>

  <button id="save-button">print to console</button>

  <script>
    var diagramUrl = 'https://cdn.statically.io/gh/bpmn-io/bpmn-js-examples/dfceecba/starter/diagram.bpmn';
    var diagram_gen = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn2:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmn2="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="4.1.0" xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL BPMN20.xsd">
  <bpmn2:process id="Process_1" isExecutable="false">
    <bpmn2:startEvent id="StartEvent_1" name="StartEvent_1" />
  </bpmn2:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="StartEvent_1">
        <dc:Bounds x="182" y="82" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="168" y="125" width="64" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn2:definitions>`

    // modeler instance
    var bpmnModeler = new BpmnJS({
      container: '#canvas',
      keyboard: {
        bindTo: window
      }
    });

    openDiagram(diagram_gen)


    const bpmnFactory = bpmnModeler.get('bpmnFactory'),
      elementFactory = bpmnModeler.get('elementFactory'),
      elementRegistry = bpmnModeler.get('elementRegistry'),
      modeling = bpmnModeler.get('modeling');

    console.log(elementRegistry)

    const process = elementRegistry.get('Process_1')

    console.log(process);

    const startEvent = elementRegistry.get('StartEvent_1');
    // const taskBusinessObject = bpmnFactory.create('bpmn:Task', { id: 'Task_1', name: 'Task' });
    // const task = elementFactory.createShape({ type: 'bpmn:Task', businessObject: taskBusinessObject });
    // modeling.createShape(task, { x: 400, y: 100 }, process);
    console.log(startEvent);

    /**
     * Save diagram contents and print them to the console.
     */
    async function exportDiagram() {

      try {

        var result = await bpmnModeler.saveXML({ format: true });

        alert('Diagram exported. Check the developer tools!');

        console.log('DIAGRAM', result.xml);
      } catch (err) {

        console.error('could not save BPMN 2.0 diagram', err);
      }
    }

    /**
     * Open diagram in our modeler instance.
     *
     * @param {String} bpmnXML diagram to display
     */
    async function openDiagram(bpmnXML) {

      // import diagram
      try {

        await bpmnModeler.importXML(bpmnXML);

        // access modeler components
        var canvas = bpmnModeler.get('canvas');
        var overlays = bpmnModeler.get('overlays');


        // zoom to fit full viewport
        canvas.zoom('fit-viewport');

        // attach an overlay to a node
        overlays.add('SCAN_OK', 'note', {
          position: {
            bottom: 0,
            right: 0
          },
          html: '<div class="diagram-note">Mixed up the labels?</div>'
        });

        // add marker
        canvas.addMarker('SCAN_OK', 'needs-discussion');
      } catch (err) {

        console.error('could not import BPMN 2.0 diagram', err);
      }
    }

    // bpmnModeler.on("element.changed", (event) => {
    //   console.log(event)
    // })


    async function OpenAICompletion() {
      $.ajax({
        url: 'https://api.openai.com/v1/chat/completions',
        type: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + $('#openai-api-token').val()
        },
        data: JSON.stringify({
          "model": "gpt-3.5-turbo",
          "messages": [
            {
              "role": "system",
              "content": "You are a poetic assistant, skilled in explaining complex programming concepts with creative flair."
            },
            {
              "role": "user",
              "content": "Compose a poem that explains the concept of recursion in programming."
            }
          ]
        }),
        success: function (response) {
          // Handle response here
          console.log(response);
        },
        error: function (xhr, status, error) {
          // Handle errors here
          console.error(xhr.responseText);
        }
      });
    }


    // load external diagram file via AJAX and open it
    // $.get(diagramUrl, openDiagram, 'text');

    // wire save button
    $('#save-button').click(exportDiagram);
  </script>

  <!--
      Thanks for trying out our BPMN toolkit!

      This example uses the pre-built distribution of the bpmn-js modeler.
      Consider rolling your own distribution to have more flexibility
      regarding which features to include.

      Checkout our advanced examples section to learn more:
      * https://github.com/bpmn-io/bpmn-js-examples#advanced

      To get a bit broader overview over how bpmn-js works,
      follow our walkthrough:
      * https://bpmn.io/toolkit/bpmn-js/walkthrough/

      Related starters:
      * https://raw.githubusercontent.com/bpmn-io/bpmn-js-examples/starter/viewer.html
    -->
</body>

</html>